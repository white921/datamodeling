

{% extends "base.html" %}

{% block title %}試験一覧 - 試験問題管理システム{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-file-alt"></i> 試験一覧
        </h2>
        <p class="text-muted">学部・学科・年度による絞り込み検索が可能です</p>
    </div>
</div>

<!-- 検索フォーム -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> 検索・絞り込み</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('exams_filtered') }}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="faculty_filter" class="form-label">学部名</label>
                            <input type="text" class="form-control" id="faculty_filter" name="faculty_filter" 
                                   value="{{ faculty_filter or '' }}" placeholder="例: 理工学部">
                            <small class="form-text text-muted">部分一致検索（%ワイルドカード使用可）</small>
                        </div>
                        <div class="col-md-3">
                            <label for="department_filter" class="form-label">学科名</label>
                            <input type="text" class="form-control" id="department_filter" name="department_filter" 
                                   value="{{ department_filter or '' }}" placeholder="例: 情報工学科">
                        </div>
                        <div class="col-md-3">
                            <label for="subject_filter" class="form-label">科目名</label>
                            <input type="text" class="form-control" id="subject_filter" name="subject_filter" 
                                   value="{{ subject_filter or '' }}" placeholder="例: データベース">
                        </div>
                        <div class="col-md-2">
                            <label for="year_filter" class="form-label">年度</label>
                            <input type="number" class="form-control" id="year_filter" name="year_filter" 
                                   value="{{ year_filter or '' }}" min="2020" max="2030" placeholder="2024">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100 d-block">
                                <i class="fas fa-search"></i>
                                <span class="d-none d-lg-inline"> 検索</span>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <a href="{{ url_for('exams') }}" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="fas fa-undo"></i> 絞り込み解除
                            </a>
                            <!-- モバイル用の検索ボタン -->
                            <button type="submit" class="btn btn-primary btn-sm d-md-none">
                                <i class="fas fa-search"></i> 検索実行
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 試験一覧 -->
<div class="row">
    <div class="col-12">
        {% if exam_list %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 検索結果
                        <span class="badge bg-primary">{{ exam_list|length }}件</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>学部</th>
                                    <th>学科</th>
                                    <th>科目名</th>
                                    <th>試験種別</th>
                                    <th>年度</th>
                                    <th>担当者</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for exam in exam_list %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ exam[1] }}</span>
                                    </td>
                                    <td>{{ exam[2] }}</td>
                                    <td>
                                        <strong>{{ exam[3] }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ exam[4] }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark">{{ exam[5] }}年度</span>
                                    </td>
                                    <td>
                                        {% if exam[6] %}
                                            <small class="text-muted">{{ exam[6] }}</small>
                                        {% else %}
                                            <small class="text-muted">未設定</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('exam_detail', exam_id=exam[0]) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> 詳細
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                {% if faculty_filter or department_filter or subject_filter or year_filter %}
                    指定した条件に一致する試験が見つかりませんでした。検索条件を変更してお試しください。
                {% else %}
                    試験データが登録されていません。
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- クイックフィルター -->
{% if exam_list %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-filter"></i> クイックフィルター</h6>
            </div>
            <div class="card-body">
                <div class="btn-group-vertical d-md-none" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="filterByYear(2024)">2024年度</button>
                    <button type="button" class="btn btn-outline-primary btn-sm mb-1" onclick="filterByYear(2023)">2023年度</button>
                    <button type="button" class="btn btn-outline-success btn-sm mb-1" onclick="filterByType('定期試験')">定期試験</button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterByType('中間試験')">中間試験</button>
                </div>
                <div class="d-none d-md-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByYear(2024)">2024年度</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByYear(2023)">2023年度</button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterByType('定期試験')">定期試験</button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterByType('中間試験')">中間試験</button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterByFaculty('理工学部')">理工学部</button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterByFaculty('文学部')">文学部</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterByYear(year) {
    document.getElementById('year_filter').value = year;
    document.querySelector('form').submit();
}

function filterByType(type) {
    // 試験種別での絞り込みは科目名フィールドを活用
    document.getElementById('subject_filter').value = '';
    document.getElementById('faculty_filter').value = '';
    document.getElementById('department_filter').value = '';
    // より高度な絞り込みは将来的に実装
    alert('試験種別: ' + type + ' での絞り込みは次回更新で対応予定です');
}

function filterByFaculty(faculty) {
    document.getElementById('faculty_filter').value = faculty;
    document.querySelector('form').submit();
}

// テーブルの行ホバー効果
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('click', function() {
            const detailBtn = this.querySelector('.btn-outline-primary');
            if (detailBtn) {
                window.location.href = detailBtn.href;
            }
        });
    });
});
</script>

<style>
/* 検索ボタンの修正 */
.btn-search-fix {
    min-height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* フォームラベルの統一 */
.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

/* モバイル対応の改善 */
@media (max-width: 768px) {
    .col-md-1 .btn {
        margin-top: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.7rem;
    }
}

/* テーブル行のホバー効果 */
tbody tr {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

/* 検索フォームの改善 */
.card-body form {
    margin-bottom: 0;
}

/* ボタングループの改善 */
.btn-group-vertical .btn,
.d-flex .btn {
    margin-bottom: 0.25rem;
}

.d-flex.gap-2 > *:not(:last-child) {
    margin-right: 0.5rem;
}
</style>
{% endblock %}