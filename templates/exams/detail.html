{% extends "base.html" %}

{% block title %}{{ exam[3] }}({{ exam[4] }}) - 試験詳細{% endblock %}

{% block content %}
<!-- パンくずリスト -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exams') }}">試験一覧</a></li>
        <li class="breadcrumb-item active">{{ exam[3] }}</li>
    </ol>
</nav>

<!-- 試験基本情報 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-file-alt"></i> {{ exam[3] }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">学部:</th>
                                    <td><span class="badge bg-secondary fs-6">{{ exam[1] }}</span></td>
                                </tr>
                                <tr>
                                    <th>学科:</th>
                                    <td><span class="badge bg-info fs-6">{{ exam[2] }}</span></td>
                                </tr>
                                <tr>
                                    <th>科目名:</th>
                                    <td><strong class="fs-5">{{ exam[3] }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">試験種別:</th>
                                    <td><span class="badge bg-success fs-6">{{ exam[4] }}</span></td>
                                </tr>
                                <tr>
                                    <th>年度:</th>
                                    <td><span class="badge bg-warning text-dark fs-6">{{ exam[5] }}年度</span></td>
                                </tr>
                                <tr>
                                    <th>担当者:</th>
                                    <td>
                                        {% if exam[7] %}
                                            <span class="text-primary">{{ exam[7] }}</span>
                                        {% else %}
                                            <span class="text-muted">未設定</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 注意事項 -->
                {% if exam[6] %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> 試験実施時の注意事項</h6>
                            <p class="mb-0">{{ exam[6] }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 試験問題画像 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-images"></i> 試験問題</h5>
            </div>
            <div class="card-body">
                {% if questions %}
                    <div class="row">
                        {% for question in questions %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <small class="text-muted">問題 {{ loop.index }}</small>
                                </div>
                                <div class="card-body text-center">
                                    {% if question.picture %}
                                        <!-- 画像ファイルが存在する場合 -->
                                        {% set image_path = url_for('static', filename='uploads/' + question.picture) %}
                                        <div class="mb-3">
                                            <img src="{{ image_path }}" 
                                                 class="img-fluid rounded shadow-sm" 
                                                 alt="試験問題画像"
                                                 style="max-height: 300px; cursor: pointer;"
                                                 onclick="openImageModal('{{ image_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                        </div>
                                        <p class="small text-muted mb-2">{{ question.picture }}</p>
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="openImageModal('{{ image_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                            <i class="fas fa-expand"></i> 拡大表示
                                        </button>
                                    {% else %}
                                        <!-- 画像ファイルが存在しない場合 -->
                                        <div class="text-center p-4">
                                            <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">画像ファイルが設定されていません</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">問題ID: {{ question.question_id }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        この試験には問題画像が登録されていません。
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 関連情報・操作ボタン -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> 操作</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('exams') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 試験一覧に戻る
                    </a>
                    <button class="btn btn-outline-primary" onclick="printPage()">
                        <i class="fas fa-print"></i> 印刷
                    </button>
                    <button class="btn btn-outline-success" onclick="shareExam()">
                        <i class="fas fa-share"></i> 共有
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportIssue()">
                        <i class="fas fa-exclamation-circle"></i> 問題を報告
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 画像拡大モーダル -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">試験問題画像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="試験問題画像">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> ダウンロード
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 画像拡大モーダル
function openImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalLabel').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// 画像ダウンロード
function downloadImage() {
    const img = document.getElementById('modalImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = img.alt + '.jpg';
    link.click();
}

// ページ印刷
function printPage() {
    // 印刷用CSSを適用してから印刷
    window.print();
}

// 試験情報共有
function shareExam() {
    const url = window.location.href;
    const title = '{{ exam[3] }}({{ exam[4] }}, {{ exam[5] }}年度)';
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        // フォールバック: URLをクリップボードにコピー
        navigator.clipboard.writeText(url).then(() => {
            alert('URLがクリップボードにコピーされました');
        });
    }
}

// 問題報告
function reportIssue() {
    const examInfo = '{{ exam[3] }}({{ exam[4] }}, {{ exam[5] }}年度)';
    const message = `以下の試験について問題を報告します:\n\n試験: ${examInfo}\nURL: ${window.location.href}\n\n問題の詳細:\n`;
    
    // メール作成（実際の環境では適切な報告システムに置き換え）
    const mailtoLink = `mailto:admin@example.com?subject=試験問題の報告&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    // Escキーでモーダルを閉じる
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
    
    // Ctrl+Pで印刷
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printPage();
    }
});

// 画像の遅延読み込み対応
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLvlg4/jgYzopovjgaTjgYvjgorjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';
            this.alt = '画像が見つかりません';
        });
    });
});
</script>

<style>
/* 印刷用スタイル */
@media print {
    .btn, .modal, nav, .card-header h5 {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    
    .badge {
        border: 1px solid #000 !important;
        color: #000 !important;
    }
}

/* カードホバー効果 */
.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* 画像ホバー効果 */
img[onclick] {
    transition: transform 0.2s ease-in-out;
}

img[onclick]:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}