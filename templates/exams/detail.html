{% extends "base.html" %}

{% block title %}{{ exam[3] }}({{ exam[4] }}) - è©¦é¨“è©³ç´°{% endblock %}

{% block content %}
<!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ãƒ›ãƒ¼ãƒ </a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exams') }}">è©¦é¨“ä¸€è¦§</a></li>
        <li class="breadcrumb-item active">{{ exam[3] }}</li>
    </ol>
</nav>

<!-- è©¦é¨“åŸºæœ¬æƒ…å ± -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-file-alt"></i> {{ exam[3] }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">å­¦éƒ¨:</th>
                                    <td><span class="badge bg-secondary fs-6">{{ exam[1] }}</span></td>
                                </tr>
                                <tr>
                                    <th>å­¦ç§‘:</th>
                                    <td><span class="badge bg-info fs-6">{{ exam[2] }}</span></td>
                                </tr>
                                <tr>
                                    <th>ç§‘ç›®å:</th>
                                    <td><strong class="fs-5">{{ exam[3] }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">è©¦é¨“ç¨®åˆ¥:</th>
                                    <td><span class="badge bg-success fs-6">{{ exam[4] }}</span></td>
                                </tr>
                                <tr>
                                    <th>å¹´åº¦:</th>
                                    <td><span class="badge bg-warning text-dark fs-6">{{ exam[5] }}å¹´åº¦</span></td>
                                </tr>
                                <tr>
                                    <th>æ‹…å½“è€…:</th>
                                    <td>
                                        {% if exam[7] %}
                                            <span class="text-primary">{{ exam[7] }}</span>
                                        {% else %}
                                            <span class="text-muted">æœªè¨­å®š</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ³¨æ„äº‹é … -->
                {% if exam[6] %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> è©¦é¨“å®Ÿæ–½æ™‚ã®æ³¨æ„äº‹é …</h6>
                            <p class="mb-0">{{ exam[6] }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- è©¦é¨“å•é¡Œç”»åƒ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-images"></i> è©¦é¨“å•é¡Œ</h5>
            </div>
            <div class="card-body">
                {% if questions %}
                    <div class="row">
                        {% for question in questions %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <small class="text-muted">å•é¡Œ {{ loop.index }}</small>
                                </div>
                                <div class="card-body text-center">
                                    {% if question.picture %}
                                        {% set file_path = url_for('uploaded_file', filename=question.picture) %}
                                        {% set file_extension = question.picture.split('.')[-1].lower() %}
                                        
                                        {% if file_extension == 'pdf' %}
                                            <!-- PDF ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ -->
                                            <div class="mb-3">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="{{ file_path }}" target="_blank" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-eye"></i> PDFã‚’é–‹ã
                                                </a>
                                                <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                                </a>
                                            </div>
                                        {% elif file_extension in ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'] %}
                                            <!-- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ -->
                                        <div class="mb-3">
                                                <img src="{{ file_path }}" 
                                                 class="img-fluid rounded shadow-sm" 
                                                 alt="è©¦é¨“å•é¡Œç”»åƒ"
                                                 style="max-height: 300px; cursor: pointer;"
                                                     onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - å•é¡Œ{{ loop.index }}')">
                                        </div>
                                        <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - å•é¡Œ{{ loop.index }}')">
                                            <i class="fas fa-expand"></i> æ‹¡å¤§è¡¨ç¤º
                                        </button>
                                                <a href="{{ file_path }}" download class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ -->
                                            <div class="mb-3">
                                                <i class="fas fa-file fa-4x text-muted mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ -->
                                        <div class="text-center p-4">
                                            <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">å•é¡ŒID: {{ question.question_id }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        ã“ã®è©¦é¨“ã«ã¯å•é¡Œç”»åƒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- é–¢é€£æƒ…å ±ãƒ»æ“ä½œãƒœã‚¿ãƒ³ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> æ“ä½œ</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('exams') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> è©¦é¨“ä¸€è¦§ã«æˆ»ã‚‹
                    </a>
                    
                    <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ï¼šä½œæˆè€…ã®ã¿è¡¨ç¤º -->
                    {% if session.user_id and exam.created_by == session.user_id %}
                    <a href="{{ url_for('exam_edit', exam_id=exam.exam_id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> è©¦é¨“ã‚’ç·¨é›†
                    </a>
                    <button type="button" 
                            class="btn btn-danger" 
                            id="detail-delete-btn"
                            data-exam-id="{{ exam.exam_id }}"
                            data-subject-name="{{ exam[3] }}"
                            data-exam-type="{{ exam[4] }}"
                            data-exam-year="{{ exam[5] }}"
                            data-faculty="{{ exam[1] }}"
                            data-department="{{ exam[2] }}"
                            data-professor="{{ exam[7] or '' }}"
                            data-instructions="{{ exam[6] or '' }}"
                            onclick="openDeleteModal(this)">
                        <i class="fas fa-trash"></i> è©¦é¨“ã‚’å‰Šé™¤
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-primary" onclick="printExamQuestions()">
                        <i class="fas fa-print"></i> è©¦é¨“å•é¡Œã‚’å°åˆ·
                    </button>
                    <button class="btn btn-outline-success" onclick="shareExam()">
                        <i class="fas fa-share"></i> å…±æœ‰
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportIssue()">
                        <i class="fas fa-exclamation-circle"></i> å•é¡Œã‚’å ±å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">è©¦é¨“å•é¡Œç”»åƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="è©¦é¨“å•é¡Œç”»åƒ">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è©³ç´°å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="detailDeleteModal" tabindex="-1" aria-labelledby="detailDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="detailDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> è©¦é¨“å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-3x me-3"></i>
                    <div>
                        <h6 class="fw-bold mb-2">é‡è¦ãªè­¦å‘Š</h6>
                        <p class="mb-0">
                            ã“ã®è©¦é¨“ã‚’<strong>å®Œå…¨ã«å‰Šé™¤</strong>ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚<br>
                            ã“ã®æ“ä½œã¯<strong>å…ƒã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã›ã‚“</strong>ã€‚
                        </p>
                    </div>
                </div>
                
                <!-- è©¦é¨“æƒ…å ± -->
                <div class="exam-detail-info">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt text-primary"></i> å‰Šé™¤å¯¾è±¡ã®è©¦é¨“
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tbody>
                                    <tr>
                                        <th class="text-muted" style="width: 100px;">å­¦éƒ¨:</th>
                                        <td>{{ exam[1] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">å­¦ç§‘:</th>
                                        <td>{{ exam[2] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">ç§‘ç›®å:</th>
                                        <td><strong>{{ exam[3] }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tbody>
                                    <tr>
                                        <th class="text-muted" style="width: 100px;">è©¦é¨“ç¨®åˆ¥:</th>
                                        <td>{{ exam[4] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">å¹´åº¦:</th>
                                        <td>{{ exam[5] }}å¹´åº¦</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">æ‹…å½“è€…:</th>
                                        <td>{{ exam[7] or 'æœªè¨­å®š' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {% if exam[6] %}
                    <div class="alert alert-info mt-3">
                        <h6 class="fw-bold">
                            <i class="fas fa-info-circle"></i> æ³¨æ„äº‹é …
                        </h6>
                        <p class="mb-0">{{ exam[6] }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ« -->
                {% if questions %}
                <div class="files-section mt-4">
                    <h6 class="fw-bold text-danger">
                        <i class="fas fa-files-o"></i> åŒæ™‚ã«å‰Šé™¤ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
                    </h6>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ questions|length }}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«</strong>ã‚‚åŒæ™‚ã«å‰Šé™¤ã•ã‚Œã¾ã™
                    </div>
                    <div class="files-grid">
                        {% for question in questions %}
                        <div class="file-item">
                            <div class="file-icon">
                                {% if question.picture.lower().endswith('.pdf') %}
                                    <i class="fas fa-file-pdf text-danger"></i>
                                {% elif question.picture.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')) %}
                                    <i class="fas fa-file-image text-success"></i>
                                {% else %}
                                    <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                            </div>
                            <div class="file-info">
                                <div class="file-name">{{ question.picture }}</div>
                                <small class="text-muted">å•é¡Œ {{ loop.index }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- å‰Šé™¤å†…å®¹ã®ç¢ºèª -->
                <div class="deletion-summary mt-4">
                    <h6 class="fw-bold text-danger">
                        <i class="fas fa-trash"></i> å‰Šé™¤ã•ã‚Œã‚‹å†…å®¹
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>è©¦é¨“æƒ…å ±</li>
                                <li><i class="fas fa-check text-success me-2"></i>è©¦é¨“å•é¡Œãƒ‡ãƒ¼ã‚¿</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ{{ questions|length }}å€‹ï¼‰</li>
                                <li><i class="fas fa-check text-success me-2"></i>æ‹…å½“è€…æƒ…å ±</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- æœ€çµ‚ç¢ºèª -->
                <div class="final-confirmation mt-4">
                    <div class="alert alert-danger">
                        <h6 class="fw-bold">æœ€çµ‚ç¢ºèª</h6>
                        <p class="mb-3">æœ¬å½“ã«ã“ã®è©¦é¨“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" onchange="toggleDeleteButton()">
                            <label class="form-check-label fw-bold" for="confirmDelete">
                                ç†è§£ã—ã¾ã—ãŸã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ãªã„ã“ã¨ã‚’æ‰¿çŸ¥ã§å‰Šé™¤ã—ã¾ã™ã€‚
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" onclick="executeDetailDelete()" id="detailDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> å‰Šé™¤å®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å‰Šé™¤é€²è¡ŒçŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè©³ç´°ç‰ˆï¼‰ -->
<div class="modal fade" id="detailDeleteProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">å‰Šé™¤ä¸­...</span>
                </div>
                <h5 class="fw-bold mb-2">å‰Šé™¤ä¸­ã§ã™...</h5>
                <p class="text-muted mb-0">è©¦é¨“ãƒ‡ãƒ¼ã‚¿ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™</p>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- å°åˆ·ç”¨ã®éš ã—ãƒ‡ãƒ¼ã‚¿ -->
<script type="application/json" id="exam-data">
{
    "title": "{{ exam[3] }}",
    "faculty": "{{ exam[1] }}",
    "department": "{{ exam[2] }}",
    "examType": "{{ exam[4] }}",
    "year": "{{ exam[5] }}",
    "professor": "{{ exam[7] or '' }}",
    "instructions": "{{ exam[6] or '' }}",
    "questions": [
        {% for question in questions %}
        {
            "id": {{ loop.index }},
            "filename": "{{ question.picture }}",
            "path": "{{ url_for('uploaded_file', filename=question.picture) }}",
            "extension": "{{ question.picture.split('.')[-1].lower() }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
<script>
// è©¦é¨“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå¤‰æ•°åã‚’å¤‰æ›´ï¼‰
const examDetailData = JSON.parse(document.getElementById('exam-data').textContent);

// ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ«
function openImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalLabel').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
function downloadImage() {
    const img = document.getElementById('modalImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = img.alt + '.jpg';
    link.click();
}

// è©¦é¨“å•é¡Œç”»åƒã®ã¿ã‚’å°åˆ·
function printExamQuestions() {
    if (examDetailData.questions.length === 0) {
        alert('å°åˆ·å¯èƒ½ãªè©¦é¨“å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    // å°åˆ·ç”¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
    const printWindow = window.open('', '_blank');
    
    // å°åˆ·ç”¨HTMLã‚’æ§‹ç¯‰
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${examDetailData.title} - ${examDetailData.examType} (${examDetailData.year}å¹´åº¦)</title>
            <style>
                @page {
                    margin: 20mm;
                    size: A4;
                }
                
                body {
                    font-family: 'MS Gothic', monospace;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000;
                }
                
                .print-header h1 {
                    font-size: 18px;
                    margin: 0;
                    font-weight: bold;
                }
                
                .print-header p {
                    font-size: 12px;
                    margin: 5px 0 0 0;
                    color: #333;
                }
                
                .question-container {
                    page-break-inside: avoid;
                    margin-bottom: 30px;
                }
                
                .question-title {
                    font-size: 14px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 5px 10px;
                    background-color: #f0f0f0;
                    border-left: 4px solid #333;
                }
                
                .question-image {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    margin-bottom: 10px;
                }
                
                .pdf-placeholder {
                    border: 2px dashed #ccc;
                    padding: 40px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 10px;
                }
                
                .file-info {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 15px;
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${examDetailData.title}</h1>
                <p>${examDetailData.faculty} ${examDetailData.department} - ${examDetailData.examType} (${examDetailData.year}å¹´åº¦)</p>`;
                
    if (examDetailData.professor) {
        printContent += `<p>æ‹…å½“: ${examDetailData.professor}</p>`;
    }
    
    if (examDetailData.instructions) {
        printContent += `<p style="font-size: 11px; margin-top: 10px;">${examDetailData.instructions}</p>`;
    }
    
    printContent += `</div>`;
    
    // å„å•é¡Œã‚’å°åˆ·ç”¨ã«è¿½åŠ 
    examDetailData.questions.forEach((question, index) => {
        printContent += `<div class="question-container">`;
        printContent += `<div class="question-title">å•é¡Œ ${question.id}</div>`;
        
        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'].includes(question.extension)) {
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
            printContent += `<img src="${question.path}" class="question-image" alt="å•é¡Œ${question.id}">`;
        } else if (question.extension === 'pdf') {
            // PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
            printContent += `
                <div class="pdf-placeholder">
                    <strong>ğŸ“„ PDFãƒ•ã‚¡ã‚¤ãƒ«</strong><br>
                    ãƒ•ã‚¡ã‚¤ãƒ«å: ${question.filename}<br>
                    <small>â€» PDFãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¥é€”é–‹ã„ã¦å°åˆ·ã—ã¦ãã ã•ã„</small>
                </div>
            `;
        }
        
        printContent += `<div class="file-info">ãƒ•ã‚¡ã‚¤ãƒ«å: ${question.filename}</div>`;
        printContent += `</div>`;
    });
    
    printContent += `
            <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666;">
                å°åˆ·æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
            </div>
        </body>
        </html>
    `;
    
    // å°åˆ·ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›¸ãè¾¼ã¿
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’å¾…ã£ã¦ã‹ã‚‰å°åˆ·
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}

// è©¦é¨“æƒ…å ±å…±æœ‰
function shareExam() {
    const url = window.location.href;
    const title = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}å¹´åº¦)`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ');
        });
    }
}

// å•é¡Œå ±å‘Š
function reportIssue() {
    const examInfo = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}å¹´åº¦)`;
    const message = `ä»¥ä¸‹ã®è©¦é¨“ã«ã¤ã„ã¦å•é¡Œã‚’å ±å‘Šã—ã¾ã™:\n\nè©¦é¨“: ${examInfo}\nURL: ${window.location.href}\n\nå•é¡Œã®è©³ç´°:\n`;
    
    const mailtoLink = `mailto:admin@example.com?subject=è©¦é¨“å•é¡Œã®å ±å‘Š&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
    
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printExamQuestions();
    }
});

// ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿å¯¾å¿œ
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLvlg4/jgYzopovjgaTjgYvjgorjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';
            this.alt = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        });
    });
});

// è©³ç´°å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openDetailDeleteModal() {
    const modal = new bootstrap.Modal(document.getElementById('detailDeleteModal'));
    modal.show();
}

// å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰
function openDeleteModal(button) {
    // ãƒœã‚¿ãƒ³ã‹ã‚‰exam_idã‚’å–å¾—
    const examId = button.getAttribute('data-exam-id');
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
    window.currentExamData = {
        id: examId,
        subjectName: button.getAttribute('data-subject-name'),
        examType: button.getAttribute('data-exam-type'),
        examYear: button.getAttribute('data-exam-year'),
        faculty: button.getAttribute('data-faculty'),
        department: button.getAttribute('data-department'),
        professor: button.getAttribute('data-professor'),
        instructions: button.getAttribute('data-instructions')
    };
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = new bootstrap.Modal(document.getElementById('detailDeleteModal'));
    modal.show();
}

// å‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
function toggleDeleteButton() {
    const checkbox = document.getElementById('confirmDelete');
    const button = document.getElementById('detailDeleteBtn');
    
    if (checkbox.checked) {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-trash"></i> å‰Šé™¤å®Ÿè¡Œ';
    } else {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-trash"></i> å‰Šé™¤å®Ÿè¡Œ';
    }
}

// è©³ç´°å‰Šé™¤å®Ÿè¡Œ
function executeDetailDelete() {
    const examId = window.currentExamData.id;
    
    // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('detailDeleteModal'));
    confirmModal.hide();
    
    // é€²è¡ŒçŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const progressModal = new bootstrap.Modal(document.getElementById('detailDeleteProgressModal'));
    progressModal.show();
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let progress = 0;
    const progressBar = document.querySelector('#detailDeleteProgressModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 200);
    
    // Ajax ã§å‰Šé™¤å®Ÿè¡Œ
    fetch(`/exam-delete-ajax/${examId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        
        if (data.success) {
            // æˆåŠŸæ™‚ã¯100%ã«ã—ã¦ã‹ã‚‰é–‰ã˜ã‚‹
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                progressModal.hide();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã«é·ç§»
                showSuccessModalAndRedirect(data.message);
            }, 500);
        } else {
            progressModal.hide();
            showErrorModal(data.message);
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Error:', error);
        progressModal.hide();
        showErrorModal('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
}

// æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦ä¸€è¦§ãƒšãƒ¼ã‚¸ã«é·ç§»
function showSuccessModalAndRedirect(message) {
    const successModalHtml = `
        <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-check-circle"></i> å‰Šé™¤å®Œäº†
                        </h5>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                        <h6 class="fw-bold">${message}</h6>
                        <p class="text-muted">3ç§’å¾Œã«è©¦é¨“ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...</p>
                        <div class="progress mt-3" style="height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', successModalHtml);
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
    
    // 3ç§’ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    let countdown = 3;
    const progressBar = document.querySelector('#successModal .progress-bar');
    const countdownInterval = setInterval(() => {
        countdown--;
        progressBar.style.width = ((3 - countdown) / 3 * 100) + '%';
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            window.location.href = "{{ url_for('exams') }}";
        }
    }, 1000);
}

// ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showErrorModal(message) {
    const errorModalHtml = `
        <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-circle"></i> å‰Šé™¤ã‚¨ãƒ©ãƒ¼
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-exclamation-triangle text-danger mb-3" style="font-size: 3rem;"></i>
                        <h6 class="fw-bold text-danger">å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ</h6>
                        <p class="text-muted">${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> é–‰ã˜ã‚‹
                        </button>
                        <button type="button" class="btn btn-primary" onclick="openDetailDeleteModal(); bootstrap.Modal.getInstance(document.getElementById('errorModal')).hide();">
                            <i class="fas fa-redo"></i> å†è©¦è¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', errorModalHtml);
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    errorModal.show();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰HTMLè¦ç´ ã‚’å‰Šé™¤
    document.getElementById('errorModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('detailDeleteModal');
    if (modal && modal.classList.contains('show')) {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            const deleteBtn = document.getElementById('detailDeleteBtn');
            if (!deleteBtn.disabled) {
                executeDetailDelete();
            }
        }
    }
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
document.getElementById('detailDeleteModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('confirmDelete').checked = false;
    toggleDeleteButton();
});
</script>
<script type="application/json" id="url-data">
{
    "exam_delete_ajax": "{{ url_for('exam_delete_ajax', exam_id=0) }}",
    "exam_file_delete": "{{ url_for('exam_file_delete', question_id=0) }}",
    "exams_list": "{{ url_for('exams') }}"
}
</script>

<script>
// JavaScriptå´ã§URLå–å¾—
const urlData = JSON.parse(document.getElementById('url-data').textContent);
const deleteUrl = urlData.exam_delete_ajax.replace('0', examId);

fetch(deleteUrl, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
    }
})
</script>

<style>

/* ã‚«ãƒ¼ãƒ‰ãƒ›ãƒãƒ¼åŠ¹æœ */
.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* ç”»åƒãƒ›ãƒãƒ¼åŠ¹æœ */
img[onclick] {
    transition: transform 0.2s ease-in-out;
}

img[onclick]:hover {
    transform: scale(1.05);
}

    /* è©³ç´°å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-lg {
        max-width: 800px;
    }

    .exam-detail-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .files-section {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
    }

    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .file-icon {
        font-size: 24px;
        margin-right: 12px;
        width: 30px;
        text-align: center;
    }

    .file-info {
        flex-grow: 1;
    }

    .file-name {
        font-weight: 500;
        color: #333;
        font-size: 14px;
        word-break: break-all;
    }

    .deletion-summary {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 20px;
    }

    .final-confirmation {
        border-top: 2px solid #dc3545;
        padding-top: 20px;
    }

    .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹çŠ¶æ…‹ */
    .btn-danger:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.6;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }

    /* æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fas.fa-check-circle {
        animation: bounceIn 0.5s ease-in-out;
    }

    .fas.fa-exclamation-triangle {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* ãƒ›ãƒãƒ¼åŠ¹æœ */
    .btn-danger:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .file-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }

    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š */
    .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }

    .modal-header .btn-close:focus {
        outline: 2px solid rgba(255,255,255,0.5);
    }
</style>
{% endblock %}