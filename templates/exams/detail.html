{% extends "base.html" %}

{% block title %}{{ exam[3] }}({{ exam[4] }}) - 試験詳細{% endblock %}

{% block content %}
<!-- パンくずリスト -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exams') }}">試験一覧</a></li>
        <li class="breadcrumb-item active">{{ exam[3] }}</li>
    </ol>
</nav>

<!-- 試験基本情報 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-file-alt"></i> {{ exam[3] }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">学部:</th>
                                    <td><span class="badge bg-secondary fs-6">{{ exam[1] }}</span></td>
                                </tr>
                                <tr>
                                    <th>学科:</th>
                                    <td><span class="badge bg-info fs-6">{{ exam[2] }}</span></td>
                                </tr>
                                <tr>
                                    <th>科目名:</th>
                                    <td><strong class="fs-5">{{ exam[3] }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">試験種別:</th>
                                    <td><span class="badge bg-success fs-6">{{ exam[4] }}</span></td>
                                </tr>
                                <tr>
                                    <th>年度:</th>
                                    <td><span class="badge bg-warning text-dark fs-6">{{ exam[5] }}年度</span></td>
                                </tr>
                                <tr>
                                    <th>担当者:</th>
                                    <td>
                                        {% if exam[7] %}
                                            <span class="text-primary">{{ exam[7] }}</span>
                                        {% else %}
                                            <span class="text-muted">未設定</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 注意事項 -->
                {% if exam[6] %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> 試験実施時の注意事項</h6>
                            <p class="mb-0">{{ exam[6] }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 試験問題画像 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-images"></i> 試験問題</h5>
            </div>
            <div class="card-body">
                {% if questions %}
                    <div class="row">
                        {% for question in questions %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <small class="text-muted">問題 {{ loop.index }}</small>
                                </div>
                                <div class="card-body text-center">
                                    {% if question.picture %}
                                        {% set file_path = url_for('uploaded_file', filename=question.picture) %}
                                        {% set file_extension = question.picture.split('.')[-1].lower() %}
                                        
                                        {% if file_extension == 'pdf' %}
                                            <!-- PDF ファイルの場合 -->
                                            <div class="mb-3">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="{{ file_path }}" target="_blank" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-eye"></i> PDFを開く
                                                </a>
                                                <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-download"></i> ダウンロード
                                                </a>
                                            </div>
                                        {% elif file_extension in ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'] %}
                                            <!-- 画像ファイルの場合 -->
                                            <div class="mb-3">
                                                <img src="{{ file_path }}" 
                                                     class="img-fluid rounded shadow-sm" 
                                                     alt="試験問題画像"
                                                     style="max-height: 300px; cursor: pointer;"
                                                     onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                            </div>
                                            <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                                    <i class="fas fa-expand"></i> 拡大表示
                                                </button>
                                                <a href="{{ file_path }}" download class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-download"></i> ダウンロード
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- その他のファイル形式 -->
                                            <div class="mb-3">
                                                <i class="fas fa-file fa-4x text-muted mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download"></i> ダウンロード
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <!-- ファイルが存在しない場合 -->
                                        <div class="text-center p-4">
                                            <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">ファイルが設定されていません</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">問題ID: {{ question.question_id }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        この試験には問題画像が登録されていません。
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 関連情報・操作ボタン -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> 操作</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('exams') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 試験一覧に戻る
                    </a>
                    
                    <!-- 編集・削除ボタン：作成者のみ表示 -->
                    {% if session.user_id and exam.created_by == session.user_id %}
                    <a href="{{ url_for('exam_edit', exam_id=exam.exam_id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> 試験を編集
                    </a>
                    <button type="button" 
                            class="btn btn-danger" 
                            id="detail-delete-btn"
                            data-exam-id="{{ exam.exam_id }}"
                            data-subject-name="{{ exam[3] }}"
                            data-exam-type="{{ exam[4] }}"
                            data-exam-year="{{ exam[5] }}"
                            data-faculty="{{ exam[1] }}"
                            data-department="{{ exam[2] }}"
                            data-professor="{{ exam[7] or '' }}"
                            data-instructions="{{ exam[6] or '' }}"
                            onclick="openDeleteModal(this)">
                        <i class="fas fa-trash"></i> 試験を削除
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-primary" onclick="printExamQuestions()">
                        <i class="fas fa-print"></i> 試験問題を印刷
                    </button>
                    <button class="btn btn-outline-success" onclick="shareExam()">
                        <i class="fas fa-share"></i> 共有
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportIssue()">
                        <i class="fas fa-exclamation-circle"></i> 問題を報告
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 画像拡大モーダル -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">試験問題画像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="試験問題画像">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> ダウンロード
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 詳細削除確認モーダル -->
<div class="modal fade" id="detailDeleteModal" tabindex="-1" aria-labelledby="detailDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="detailDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 試験削除確認
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-3x me-3"></i>
                    <div>
                        <h6 class="fw-bold mb-2">重要な警告</h6>
                        <p class="mb-0">
                            この試験を<strong>完全に削除</strong>しようとしています。<br>
                            この操作は<strong>元に戻すことができません</strong>。
                        </p>
                    </div>
                </div>
                
                <!-- 試験情報 -->
                <div class="exam-detail-info">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt text-primary"></i> 削除対象の試験
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tbody>
                                    <tr>
                                        <th class="text-muted" style="width: 100px;">学部:</th>
                                        <td>{{ exam[1] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">学科:</th>
                                        <td>{{ exam[2] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">科目名:</th>
                                        <td><strong>{{ exam[3] }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tbody>
                                    <tr>
                                        <th class="text-muted" style="width: 100px;">試験種別:</th>
                                        <td>{{ exam[4] }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">年度:</th>
                                        <td>{{ exam[5] }}年度</td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">担当者:</th>
                                        <td>{{ exam[7] or '未設定' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {% if exam[6] %}
                    <div class="alert alert-info mt-3">
                        <h6 class="fw-bold">
                            <i class="fas fa-info-circle"></i> 注意事項
                        </h6>
                        <p class="mb-0">{{ exam[6] }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 関連ファイル -->
                {% if questions %}
                <div class="files-section mt-4">
                    <h6 class="fw-bold text-danger">
                        <i class="fas fa-files-o"></i> 同時に削除されるファイル
                    </h6>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ questions|length }}個のファイル</strong>も同時に削除されます
                    </div>
                    <div class="files-grid">
                        {% for question in questions %}
                        <div class="file-item">
                            <div class="file-icon">
                                {% if question.picture.lower().endswith('.pdf') %}
                                    <i class="fas fa-file-pdf text-danger"></i>
                                {% elif question.picture.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')) %}
                                    <i class="fas fa-file-image text-success"></i>
                                {% else %}
                                    <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                            </div>
                            <div class="file-info">
                                <div class="file-name">{{ question.picture }}</div>
                                <small class="text-muted">問題 {{ loop.index }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 削除内容の確認 -->
                <div class="deletion-summary mt-4">
                    <h6 class="fw-bold text-danger">
                        <i class="fas fa-trash"></i> 削除される内容
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>試験情報</li>
                                <li><i class="fas fa-check text-success me-2"></i>試験問題データ</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>関連ファイル（{{ questions|length }}個）</li>
                                <li><i class="fas fa-check text-success me-2"></i>担当者情報</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 最終確認 -->
                <div class="final-confirmation mt-4">
                    <div class="alert alert-danger">
                        <h6 class="fw-bold">最終確認</h6>
                        <p class="mb-3">本当にこの試験を削除しますか？</p>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" onchange="toggleDeleteButton()">
                            <label class="form-check-label fw-bold" for="confirmDelete">
                                理解しました。この操作は元に戻せないことを承知で削除します。
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> キャンセル
                </button>
                <button type="button" class="btn btn-danger" onclick="executeDetailDelete()" id="detailDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> 削除実行
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 削除進行状況モーダル（詳細版） -->
<div class="modal fade" id="detailDeleteProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">削除中...</span>
                </div>
                <h5 class="fw-bold mb-2">削除中です...</h5>
                <p class="text-muted mb-0">試験データとファイルを削除しています</p>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- 印刷用の隠しデータ -->
<script type="application/json" id="exam-data">
{
    "title": "{{ exam[3] }}",
    "faculty": "{{ exam[1] }}",
    "department": "{{ exam[2] }}",
    "examType": "{{ exam[4] }}",
    "year": "{{ exam[5] }}",
    "professor": "{{ exam[7] or '' }}",
    "instructions": "{{ exam[6] or '' }}",
    "questions": [
        {% for question in questions %}
        {
            "id": {{ loop.index }},
            "filename": "{{ question.picture }}",
            "path": "{{ url_for('uploaded_file', filename=question.picture) }}",
            "extension": "{{ question.picture.split('.')[-1].lower() }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
<script>
// 試験データを取得（変数名を変更）
const examDetailData = JSON.parse(document.getElementById('exam-data').textContent);

// 画像拡大モーダル
function openImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalLabel').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// 画像ダウンロード
function downloadImage() {
    const img = document.getElementById('modalImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = img.alt + '.jpg';
    link.click();
}

// 試験問題画像のみを印刷
function printExamQuestions() {
    if (examDetailData.questions.length === 0) {
        alert('印刷可能な試験問題が見つかりません。');
        return;
    }
    
    // 印刷用のウィンドウを作成
    const printWindow = window.open('', '_blank');
    
    // 印刷用HTMLを構築
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${examDetailData.title} - ${examDetailData.examType} (${examDetailData.year}年度)</title>
            <style>
                @page {
                    margin: 20mm;
                    size: A4;
                }
                
                body {
                    font-family: 'MS Gothic', monospace;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000;
                }
                
                .print-header h1 {
                    font-size: 18px;
                    margin: 0;
                    font-weight: bold;
                }
                
                .print-header p {
                    font-size: 12px;
                    margin: 5px 0 0 0;
                    color: #333;
                }
                
                .question-container {
                    page-break-inside: avoid;
                    margin-bottom: 30px;
                }
                
                .question-title {
                    font-size: 14px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 5px 10px;
                    background-color: #f0f0f0;
                    border-left: 4px solid #333;
                }
                
                .question-image {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    margin-bottom: 10px;
                }
                
                .pdf-placeholder {
                    border: 2px dashed #ccc;
                    padding: 40px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 10px;
                }
                
                .file-info {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 15px;
                }
                
                @media print {
                    .question-container {
                        page-break-after: auto;
                        page-break-inside: avoid;
                    }
                    
                    .pdf-placeholder {
                        border: 2px solid #000;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${examDetailData.title}</h1>
                <p>${examDetailData.faculty} ${examDetailData.department} - ${examDetailData.examType} (${examDetailData.year}年度)</p>`;
                
    if (examDetailData.professor) {
        printContent += `<p>担当: ${examDetailData.professor}</p>`;
    }
    
    if (examDetailData.instructions) {
        printContent += `<p style="font-size: 11px; margin-top: 10px;">${examDetailData.instructions}</p>`;
    }
    
    printContent += `</div>`;
    
    // 各問題を印刷用に追加
    examDetailData.questions.forEach((question, index) => {
        printContent += `<div class="question-container">`;
        printContent += `<div class="question-title">問題 ${question.id}</div>`;
        
        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'].includes(question.extension)) {
            // 画像ファイルの場合
            printContent += `<img src="${question.path}" class="question-image" alt="問題${question.id}">`;
        } else if (question.extension === 'pdf') {
            // PDFファイルの場合
            printContent += `
                <div class="pdf-placeholder">
                    <strong>📄 PDFファイル</strong><br>
                    ファイル名: ${question.filename}<br>
                    <small>※ PDFファイルは別途開いて印刷してください</small>
                </div>
            `;
        }
        
        printContent += `<div class="file-info">ファイル名: ${question.filename}</div>`;
        printContent += `</div>`;
    });
    
    printContent += `
            <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666;">
                印刷日時: ${new Date().toLocaleString('ja-JP')}
            </div>
        </body>
        </html>
    `;
    
    // 印刷ウィンドウにコンテンツを書き込み
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // 画像の読み込みを待ってから印刷
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}

// 試験情報共有
function shareExam() {
    const url = window.location.href;
    const title = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}年度)`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLがクリップボードにコピーされました');
        });
    }
}

// 問題報告
function reportIssue() {
    const examInfo = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}年度)`;
    const message = `以下の試験について問題を報告します:\n\n試験: ${examInfo}\nURL: ${window.location.href}\n\n問題の詳細:\n`;
    
    const mailtoLink = `mailto:admin@example.com?subject=試験問題の報告&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
    
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printExamQuestions();
    }
});

// 画像の遅延読み込み対応
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLvlg4/jgYzopovjgaTjgYvjgorjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';
            this.alt = '画像が見つかりません';
        });
    });
});

// 詳細削除モーダルを開く
function openDetailDeleteModal() {
    const modal = new bootstrap.Modal(document.getElementById('detailDeleteModal'));
    modal.show();
}

// 削除モーダルを開く（ボタンクリック時）
function openDeleteModal(button) {
    // ボタンからexam_idを取得
    const examId = button.getAttribute('data-exam-id');
    
    // グローバル変数に保存
    window.currentExamData = {
        id: examId,
        subjectName: button.getAttribute('data-subject-name'),
        examType: button.getAttribute('data-exam-type'),
        examYear: button.getAttribute('data-exam-year'),
        faculty: button.getAttribute('data-faculty'),
        department: button.getAttribute('data-department'),
        professor: button.getAttribute('data-professor'),
        instructions: button.getAttribute('data-instructions')
    };
    
    // モーダルを開く
    const modal = new bootstrap.Modal(document.getElementById('detailDeleteModal'));
    modal.show();
}

// 削除ボタンの有効/無効を切り替え
function toggleDeleteButton() {
    const checkbox = document.getElementById('confirmDelete');
    const button = document.getElementById('detailDeleteBtn');
    
    if (checkbox.checked) {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-trash"></i> 削除実行';
    } else {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-trash"></i> 削除実行';
    }
}

// 詳細削除実行
function executeDetailDelete() {
    const examId = window.currentExamData.id;
    
    // 確認モーダルを閉じる
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('detailDeleteModal'));
    confirmModal.hide();
    
    // 進行状況モーダルを表示
    const progressModal = new bootstrap.Modal(document.getElementById('detailDeleteProgressModal'));
    progressModal.show();
    
    // プログレスバーアニメーション
    let progress = 0;
    const progressBar = document.querySelector('#detailDeleteProgressModal .progress-bar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 200);
    
    // Ajax で削除実行
    fetch(`/exam-delete-ajax/${examId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        
        if (data.success) {
            // 成功時は100%にしてから閉じる
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                progressModal.hide();
                
                // 成功メッセージを表示してから一覧ページに遷移
                showSuccessModalAndRedirect(data.message);
            }, 500);
        } else {
            progressModal.hide();
            showErrorModal(data.message);
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Error:', error);
        progressModal.hide();
        showErrorModal('削除中にエラーが発生しました');
    });
}

// 成功モーダルを表示して一覧ページに遷移
function showSuccessModalAndRedirect(message) {
    const successModalHtml = `
        <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-check-circle"></i> 削除完了
                        </h5>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                        <h6 class="fw-bold">${message}</h6>
                        <p class="text-muted">3秒後に試験一覧ページに移動します...</p>
                        <div class="progress mt-3" style="height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', successModalHtml);
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
    
    // 3秒のカウントダウン
    let countdown = 3;
    const progressBar = document.querySelector('#successModal .progress-bar');
    const countdownInterval = setInterval(() => {
        countdown--;
        progressBar.style.width = ((3 - countdown) / 3 * 100) + '%';
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            window.location.href = "{{ url_for('exams') }}";
        }
    }, 1000);
}

// エラーモーダルを表示
function showErrorModal(message) {
    const errorModalHtml = `
        <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-circle"></i> 削除エラー
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-exclamation-triangle text-danger mb-3" style="font-size: 3rem;"></i>
                        <h6 class="fw-bold text-danger">削除に失敗しました</h6>
                        <p class="text-muted">${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> 閉じる
                        </button>
                        <button type="button" class="btn btn-primary" onclick="openDetailDeleteModal(); bootstrap.Modal.getInstance(document.getElementById('errorModal')).hide();">
                            <i class="fas fa-redo"></i> 再試行
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', errorModalHtml);
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    errorModal.show();
    
    // モーダルが閉じられたらHTML要素を削除
    document.getElementById('errorModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// モーダルのキーボード操作
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('detailDeleteModal');
    if (modal && modal.classList.contains('show')) {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            const deleteBtn = document.getElementById('detailDeleteBtn');
            if (!deleteBtn.disabled) {
                executeDetailDelete();
            }
        }
    }
});

// モーダルが閉じられたらチェックボックスをリセット
document.getElementById('detailDeleteModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('confirmDelete').checked = false;
    toggleDeleteButton();
});
</script>

<style>
    /* 印刷用スタイル */
    @media print {
        .btn, .modal, nav, .card-header h5 {
            display: none !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            page-break-inside: avoid;
        }
        
        .badge {
            border: 1px solid #000 !important;
            color: #000 !important;
        }
    }

    /* カードホバー効果 */
    .card:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease-in-out;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* 画像ホバー効果 */
    img[onclick] {
        transition: transform 0.2s ease-in-out;
    }

    img[onclick]:hover {
        transform: scale(1.05);
    }

    /* 詳細削除モーダルのスタイル */
    .modal-lg {
        max-width: 800px;
    }

    .exam-detail-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .files-section {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
    }

    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .file-icon {
        font-size: 24px;
        margin-right: 12px;
        width: 30px;
        text-align: center;
    }

    .file-info {
        flex-grow: 1;
    }

    .file-name {
        font-weight: 500;
        color: #333;
        font-size: 14px;
        word-break: break-all;
    }

    .deletion-summary {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 20px;
    }

    .final-confirmation {
        border-top: 2px solid #dc3545;
        padding-top: 20px;
    }

    .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    /* 削除ボタンの無効状態 */
    .btn-danger:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.6;
    }

    /* プログレスバーアニメーション */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }

    /* 成功・エラーアイコンのアニメーション */
    .fas.fa-check-circle {
        animation: bounceIn 0.5s ease-in-out;
    }

    .fas.fa-exclamation-triangle {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .modal-lg {
            max-width: 95%;
            margin: 0.5rem;
        }
        
        .files-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .file-item {
            padding: 10px;
        }
        
        .file-icon {
            font-size: 20px;
            margin-right: 10px;
        }
        
        .exam-detail-info .row {
            margin-bottom: 15px;
        }
        
        .exam-detail-info .col-md-6 {
            margin-bottom: 15px;
        }
    }

    /* ホバー効果 */
    .btn-danger:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .file-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }

    /* アクセシビリティ向上 */
    .btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }

    .modal-header .btn-close:focus {
        outline: 2px solid rgba(255,255,255,0.5);
    }
</style>
{% endblock %}