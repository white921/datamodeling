{% extends "base.html" %}

{% block title %}{{ exam[3] }}({{ exam[4] }}) - Ë©¶È®ìË©≥Á¥∞{% endblock %}

{% block content %}
<!-- „Éë„É≥„Åè„Åö„É™„Çπ„Éà -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">„Éõ„Éº„É†</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exams') }}">Ë©¶È®ì‰∏ÄË¶ß</a></li>
        <li class="breadcrumb-item active">{{ exam[3] }}</li>
    </ol>
</nav>

<!-- Ë©¶È®ìÂü∫Êú¨ÊÉÖÂ†± -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-file-alt"></i> {{ exam[3] }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">Â≠¶ÈÉ®:</th>
                                    <td><span class="badge bg-secondary fs-6">{{ exam[1] }}</span></td>
                                </tr>
                                <tr>
                                    <th>Â≠¶Áßë:</th>
                                    <td><span class="badge bg-info fs-6">{{ exam[2] }}</span></td>
                                </tr>
                                <tr>
                                    <th>ÁßëÁõÆÂêç:</th>
                                    <td><strong class="fs-5">{{ exam[3] }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">Ë©¶È®ìÁ®ÆÂà•:</th>
                                    <td><span class="badge bg-success fs-6">{{ exam[4] }}</span></td>
                                </tr>
                                <tr>
                                    <th>Âπ¥Â∫¶:</th>
                                    <td><span class="badge bg-warning text-dark fs-6">{{ exam[5] }}Âπ¥Â∫¶</span></td>
                                </tr>
                                <tr>
                                    <th>ÊãÖÂΩìËÄÖ:</th>
                                    <td>
                                        {% if exam[7] %}
                                            <span class="text-primary">{{ exam[7] }}</span>
                                        {% else %}
                                            <span class="text-muted">Êú™Ë®≠ÂÆö</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Ê≥®ÊÑè‰∫ãÈ†Ö -->
                {% if exam[6] %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Ë©¶È®ìÂÆüÊñΩÊôÇ„ÅÆÊ≥®ÊÑè‰∫ãÈ†Ö</h6>
                            <p class="mb-0">{{ exam[6] }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ë©¶È®ìÂïèÈ°åÁîªÂÉè -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-images"></i> Ë©¶È®ìÂïèÈ°å</h5>
            </div>
            <div class="card-body">
                {% if questions %}
                    <div class="row">
                        {% for question in questions %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <small class="text-muted">ÂïèÈ°å {{ loop.index }}</small>
                                </div>
                                <div class="card-body text-center">
                                    {% if question.picture %}
                                        {% set file_path = url_for('uploaded_file', filename=question.picture) %}
                                        {% set file_extension = question.picture.split('.')[-1].lower() %}
                                        
                                        {% if file_extension == 'pdf' %}
                                            <!-- PDF „Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà -->
                                            <div class="mb-3">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="{{ file_path }}" target="_blank" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-eye"></i> PDF„ÇíÈñã„Åè
                                                </a>
                                                <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-download"></i> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                                                </a>
                                            </div>
                                        {% elif file_extension in ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'] %}
                                            <!-- ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà -->
                                            <div class="mb-3">
                                                <img src="{{ file_path }}" 
                                                     class="img-fluid rounded shadow-sm" 
                                                     alt="Ë©¶È®ìÂïèÈ°åÁîªÂÉè"
                                                     style="max-height: 300px; cursor: pointer;"
                                                     onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - ÂïèÈ°å{{ loop.index }}')">
                                            </div>
                                            <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - ÂïèÈ°å{{ loop.index }}')">
                                                    <i class="fas fa-expand"></i> Êã°Â§ßË°®Á§∫
                                                </button>
                                                <a href="{{ file_path }}" download class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-download"></i> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè -->
                                            <div class="mb-3">
                                                <i class="fas fa-file fa-4x text-muted mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download"></i> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <!-- „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà -->
                                        <div class="text-center p-4">
                                            <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">„Éï„Ç°„Ç§„É´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">ÂïèÈ°åID: {{ question.question_id }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        „Åì„ÅÆË©¶È®ì„Å´„ÅØÂïèÈ°åÁîªÂÉè„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Èñ¢ÈÄ£ÊÉÖÂ†±„ÉªÊìç‰Ωú„Éú„Çø„É≥ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Êìç‰Ωú</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('exams') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Ë©¶È®ì‰∏ÄË¶ß„Å´Êàª„Çã
                    </a>
                    
                    <!-- Á∑®ÈõÜ„Éú„Çø„É≥Ôºö‰ΩúÊàêËÄÖ„ÅÆ„ÅøË°®Á§∫ -->
                    {% if session.user_id and exam.created_by == session.user_id %}
                    <a href="{{ url_for('exam_edit', exam_id=exam.exam_id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Ë©¶È®ì„ÇíÁ∑®ÈõÜ
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-primary" onclick="printExamQuestions()">
                        <i class="fas fa-print"></i> Ë©¶È®ìÂïèÈ°å„ÇíÂç∞Âà∑
                    </button>
                    <button class="btn btn-outline-success" onclick="shareExam()">
                        <i class="fas fa-share"></i> ÂÖ±Êúâ
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportIssue()">
                        <i class="fas fa-exclamation-circle"></i> ÂïèÈ°å„ÇíÂ†±Âëä
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÁîªÂÉèÊã°Â§ß„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Ë©¶È®ìÂïèÈ°åÁîªÂÉè</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Ë©¶È®ìÂïèÈ°åÁîªÂÉè">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- templates/exams/detail.html„ÅÆÊúÄÂæå„ÅÆJavaScriptÈÉ®ÂàÜ„Çí‰ª•‰∏ã„Å´ÁΩÆ„ÅçÊèõ„Åà -->

<!-- Âç∞Âà∑Áî®„ÅÆÈö†„Åó„Éá„Éº„Çø -->
<script type="application/json" id="exam-data">
{
    "title": "{{ exam[3] }}",
    "faculty": "{{ exam[1] }}",
    "department": "{{ exam[2] }}",
    "examType": "{{ exam[4] }}",
    "year": "{{ exam[5] }}",
    "professor": "{{ exam[7] or '' }}",
    "instructions": "{{ exam[6] or '' }}",
    "questions": [
        {% for question in questions %}
        {
            "id": {{ loop.index }},
            "filename": "{{ question.picture }}",
            "path": "{{ url_for('uploaded_file', filename=question.picture) }}",
            "extension": "{{ question.picture.split('.')[-1].lower() }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

{% block scripts %}
<script>
// Ë©¶È®ì„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÂ§âÊï∞Âêç„ÇíÂ§âÊõ¥Ôºâ
const examDetailData = JSON.parse(document.getElementById('exam-data').textContent);

// ÁîªÂÉèÊã°Â§ß„É¢„Éº„ÉÄ„É´
function openImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalLabel').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
function downloadImage() {
    const img = document.getElementById('modalImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = img.alt + '.jpg';
    link.click();
}

// Ë©¶È®ìÂïèÈ°åÁîªÂÉè„ÅÆ„Åø„ÇíÂç∞Âà∑
function printExamQuestions() {
    if (examDetailData.questions.length === 0) {
        alert('Âç∞Âà∑ÂèØËÉΩ„Å™Ë©¶È®ìÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
        return;
    }
    
    // Âç∞Âà∑Áî®„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„Çí‰ΩúÊàê
    const printWindow = window.open('', '_blank');
    
    // Âç∞Âà∑Áî®HTML„ÇíÊßãÁØâ
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${examDetailData.title} - ${examDetailData.examType} (${examDetailData.year}Âπ¥Â∫¶)</title>
            <style>
                @page {
                    margin: 20mm;
                    size: A4;
                }
                
                body {
                    font-family: 'MS Gothic', monospace;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000;
                }
                
                .print-header h1 {
                    font-size: 18px;
                    margin: 0;
                    font-weight: bold;
                }
                
                .print-header p {
                    font-size: 12px;
                    margin: 5px 0 0 0;
                    color: #333;
                }
                
                .question-container {
                    page-break-inside: avoid;
                    margin-bottom: 30px;
                }
                
                .question-title {
                    font-size: 14px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 5px 10px;
                    background-color: #f0f0f0;
                    border-left: 4px solid #333;
                }
                
                .question-image {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    margin-bottom: 10px;
                }
                
                .pdf-placeholder {
                    border: 2px dashed #ccc;
                    padding: 40px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 10px;
                }
                
                .file-info {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 15px;
                }
                
                @media print {
                    .question-container {
                        page-break-after: auto;
                        page-break-inside: avoid;
                    }
                    
                    .pdf-placeholder {
                        border: 2px solid #000;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${examDetailData.title}</h1>
                <p>${examDetailData.faculty} ${examDetailData.department} - ${examDetailData.examType} (${examDetailData.year}Âπ¥Â∫¶)</p>`;
                
    if (examDetailData.professor) {
        printContent += `<p>ÊãÖÂΩì: ${examDetailData.professor}</p>`;
    }
    
    if (examDetailData.instructions) {
        printContent += `<p style="font-size: 11px; margin-top: 10px;">${examDetailData.instructions}</p>`;
    }
    
    printContent += `</div>`;
    
    // ÂêÑÂïèÈ°å„ÇíÂç∞Âà∑Áî®„Å´ËøΩÂä†
    examDetailData.questions.forEach((question, index) => {
        printContent += `<div class="question-container">`;
        printContent += `<div class="question-title">ÂïèÈ°å ${question.id}</div>`;
        
        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'].includes(question.extension)) {
            // ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
            printContent += `<img src="${question.path}" class="question-image" alt="ÂïèÈ°å${question.id}">`;
        } else if (question.extension === 'pdf') {
            // PDF„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
            printContent += `
                <div class="pdf-placeholder">
                    <strong>üìÑ PDF„Éï„Ç°„Ç§„É´</strong><br>
                    „Éï„Ç°„Ç§„É´Âêç: ${question.filename}<br>
                    <small>‚Äª PDF„Éï„Ç°„Ç§„É´„ÅØÂà•ÈÄîÈñã„ÅÑ„Å¶Âç∞Âà∑„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                </div>
            `;
        }
        
        printContent += `<div class="file-info">„Éï„Ç°„Ç§„É´Âêç: ${question.filename}</div>`;
        printContent += `</div>`;
    });
    
    printContent += `
            <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666;">
                Âç∞Âà∑Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}
            </div>
        </body>
        </html>
    `;
    
    // Âç∞Âà∑„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊõ∏„ÅçËæº„Åø
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÂç∞Âà∑
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}

// Ë©¶È®ìÊÉÖÂ†±ÂÖ±Êúâ
function shareExam() {
    const url = window.location.href;
    const title = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}Âπ¥Â∫¶)`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('URL„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü');
        });
    }
}

// ÂïèÈ°åÂ†±Âëä
function reportIssue() {
    const examInfo = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}Âπ¥Â∫¶)`;
    const message = `‰ª•‰∏ã„ÅÆË©¶È®ì„Å´„Å§„ÅÑ„Å¶ÂïèÈ°å„ÇíÂ†±Âëä„Åó„Åæ„Åô:\n\nË©¶È®ì: ${examInfo}\nURL: ${window.location.href}\n\nÂïèÈ°å„ÅÆË©≥Á¥∞:\n`;
    
    const mailtoLink = `mailto:admin@example.com?subject=Ë©¶È®ìÂïèÈ°å„ÅÆÂ†±Âëä&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
    
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printExamQuestions();
    }
});

// ÁîªÂÉè„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÂØæÂøú
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLvlg4/jgYzopovjgaTjgYvjgorjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';
            this.alt = 'ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
        });
    });
});
</script>

<style>
/* Âç∞Âà∑Áî®„Çπ„Çø„Ç§„É´ */
@media print {
    .btn, .modal, nav, .card-header h5 {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    
    .badge {
        border: 1px solid #000 !important;
        color: #000 !important;
    }
}

/* „Ç´„Éº„Éâ„Éõ„Éê„ÉºÂäπÊûú */
.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* ÁîªÂÉè„Éõ„Éê„ÉºÂäπÊûú */
img[onclick] {
    transition: transform 0.2s ease-in-out;
}

img[onclick]:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}