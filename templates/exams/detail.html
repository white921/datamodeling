{% extends "base.html" %}

{% block title %}{{ exam[3] }}({{ exam[4] }}) - 試験詳細{% endblock %}

{% block content %}
<!-- パンくずリスト -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('exams') }}">試験一覧</a></li>
        <li class="breadcrumb-item active">{{ exam[3] }}</li>
    </ol>
</nav>

<!-- 試験基本情報 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-file-alt"></i> {{ exam[3] }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">学部:</th>
                                    <td><span class="badge bg-secondary fs-6">{{ exam[1] }}</span></td>
                                </tr>
                                <tr>
                                    <th>学科:</th>
                                    <td><span class="badge bg-info fs-6">{{ exam[2] }}</span></td>
                                </tr>
                                <tr>
                                    <th>科目名:</th>
                                    <td><strong class="fs-5">{{ exam[3] }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th class="w-25">試験種別:</th>
                                    <td><span class="badge bg-success fs-6">{{ exam[4] }}</span></td>
                                </tr>
                                <tr>
                                    <th>年度:</th>
                                    <td><span class="badge bg-warning text-dark fs-6">{{ exam[5] }}年度</span></td>
                                </tr>
                                <tr>
                                    <th>担当者:</th>
                                    <td>
                                        {% if exam[7] %}
                                            <span class="text-primary">{{ exam[7] }}</span>
                                        {% else %}
                                            <span class="text-muted">未設定</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 注意事項 -->
                {% if exam[6] %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> 試験実施時の注意事項</h6>
                            <p class="mb-0">{{ exam[6] }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 試験問題画像 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-images"></i> 試験問題</h5>
            </div>
            <div class="card-body">
                {% if questions %}
                    <div class="row">
                        {% for question in questions %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <small class="text-muted">問題 {{ loop.index }}</small>
                                </div>
                                <div class="card-body text-center">
                                    {% if question.picture %}
                                        {% set file_path = url_for('uploaded_file', filename=question.picture) %}
                                        {% set file_extension = question.picture.split('.')[-1].lower() %}
                                        
                                        {% if file_extension == 'pdf' %}
                                            <!-- PDF ファイルの場合 -->
                                            <div class="mb-3">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <a href="{{ file_path }}" target="_blank" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-eye"></i> PDFを開く
                                                </a>
                                                <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-download"></i> ダウンロード
                                                </a>
                                            </div>
                                        {% elif file_extension in ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'] %}
                                            <!-- 画像ファイルの場合 -->
                                            <div class="mb-3">
                                                <img src="{{ file_path }}" 
                                                     class="img-fluid rounded shadow-sm" 
                                                     alt="試験問題画像"
                                                     style="max-height: 300px; cursor: pointer;"
                                                     onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                            </div>
                                            <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="openImageModal('{{ file_path }}', '{{ exam[3] }} - 問題{{ loop.index }}')">
                                                    <i class="fas fa-expand"></i> 拡大表示
                                                </button>
                                                <a href="{{ file_path }}" download class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-download"></i> ダウンロード
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- その他のファイル形式 -->
                                            <div class="mb-3">
                                                <i class="fas fa-file fa-4x text-muted mb-2"></i>
                                                <p class="small text-muted mb-2">{{ question.picture }}</p>
                                            </div>
                                            <a href="{{ file_path }}" download class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download"></i> ダウンロード
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <!-- ファイルが存在しない場合 -->
                                        <div class="text-center p-4">
                                            <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">ファイルが設定されていません</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">問題ID: {{ question.question_id }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        この試験には問題画像が登録されていません。
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 関連情報・操作ボタン -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> 操作</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('exams') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 試験一覧に戻る
                    </a>
                    
                    <!-- 編集ボタン：作成者のみ表示 -->
                    {% if session.user_id and exam.created_by == session.user_id %}
                    <a href="{{ url_for('exam_edit', exam_id=exam.exam_id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> 試験を編集
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-primary" onclick="printExamQuestions()">
                        <i class="fas fa-print"></i> 試験問題を印刷
                    </button>
                    <button class="btn btn-outline-success" onclick="shareExam()">
                        <i class="fas fa-share"></i> 共有
                    </button>
                    <button class="btn btn-outline-warning" onclick="reportIssue()">
                        <i class="fas fa-exclamation-circle"></i> 問題を報告
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 画像拡大モーダル -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">試験問題画像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="試験問題画像">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> ダウンロード
                </button>
            </div>
        </div>
    </div>
</div>

<!-- templates/exams/detail.htmlの最後のJavaScript部分を以下に置き換え -->

<!-- 印刷用の隠しデータ -->
<script type="application/json" id="exam-data">
{
    "title": "{{ exam[3] }}",
    "faculty": "{{ exam[1] }}",
    "department": "{{ exam[2] }}",
    "examType": "{{ exam[4] }}",
    "year": "{{ exam[5] }}",
    "professor": "{{ exam[7] or '' }}",
    "instructions": "{{ exam[6] or '' }}",
    "questions": [
        {% for question in questions %}
        {
            "id": {{ loop.index }},
            "filename": "{{ question.picture }}",
            "path": "{{ url_for('uploaded_file', filename=question.picture) }}",
            "extension": "{{ question.picture.split('.')[-1].lower() }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

{% block scripts %}
<script>
// 試験データを取得（変数名を変更）
const examDetailData = JSON.parse(document.getElementById('exam-data').textContent);

// 画像拡大モーダル
function openImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalLabel').textContent = title;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// 画像ダウンロード
function downloadImage() {
    const img = document.getElementById('modalImage');
    const link = document.createElement('a');
    link.href = img.src;
    link.download = img.alt + '.jpg';
    link.click();
}

// 試験問題画像のみを印刷
function printExamQuestions() {
    if (examDetailData.questions.length === 0) {
        alert('印刷可能な試験問題が見つかりません。');
        return;
    }
    
    // 印刷用のウィンドウを作成
    const printWindow = window.open('', '_blank');
    
    // 印刷用HTMLを構築
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${examDetailData.title} - ${examDetailData.examType} (${examDetailData.year}年度)</title>
            <style>
                @page {
                    margin: 20mm;
                    size: A4;
                }
                
                body {
                    font-family: 'MS Gothic', monospace;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000;
                }
                
                .print-header h1 {
                    font-size: 18px;
                    margin: 0;
                    font-weight: bold;
                }
                
                .print-header p {
                    font-size: 12px;
                    margin: 5px 0 0 0;
                    color: #333;
                }
                
                .question-container {
                    page-break-inside: avoid;
                    margin-bottom: 30px;
                }
                
                .question-title {
                    font-size: 14px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 5px 10px;
                    background-color: #f0f0f0;
                    border-left: 4px solid #333;
                }
                
                .question-image {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ddd;
                    margin-bottom: 10px;
                }
                
                .pdf-placeholder {
                    border: 2px dashed #ccc;
                    padding: 40px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    margin-bottom: 10px;
                }
                
                .file-info {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 15px;
                }
                
                @media print {
                    .question-container {
                        page-break-after: auto;
                        page-break-inside: avoid;
                    }
                    
                    .pdf-placeholder {
                        border: 2px solid #000;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${examDetailData.title}</h1>
                <p>${examDetailData.faculty} ${examDetailData.department} - ${examDetailData.examType} (${examDetailData.year}年度)</p>`;
                
    if (examDetailData.professor) {
        printContent += `<p>担当: ${examDetailData.professor}</p>`;
    }
    
    if (examDetailData.instructions) {
        printContent += `<p style="font-size: 11px; margin-top: 10px;">${examDetailData.instructions}</p>`;
    }
    
    printContent += `</div>`;
    
    // 各問題を印刷用に追加
    examDetailData.questions.forEach((question, index) => {
        printContent += `<div class="question-container">`;
        printContent += `<div class="question-title">問題 ${question.id}</div>`;
        
        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff'].includes(question.extension)) {
            // 画像ファイルの場合
            printContent += `<img src="${question.path}" class="question-image" alt="問題${question.id}">`;
        } else if (question.extension === 'pdf') {
            // PDFファイルの場合
            printContent += `
                <div class="pdf-placeholder">
                    <strong>📄 PDFファイル</strong><br>
                    ファイル名: ${question.filename}<br>
                    <small>※ PDFファイルは別途開いて印刷してください</small>
                </div>
            `;
        }
        
        printContent += `<div class="file-info">ファイル名: ${question.filename}</div>`;
        printContent += `</div>`;
    });
    
    printContent += `
            <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666;">
                印刷日時: ${new Date().toLocaleString('ja-JP')}
            </div>
        </body>
        </html>
    `;
    
    // 印刷ウィンドウにコンテンツを書き込み
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // 画像の読み込みを待ってから印刷
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        }, 500);
    };
}

// 試験情報共有
function shareExam() {
    const url = window.location.href;
    const title = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}年度)`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLがクリップボードにコピーされました');
        });
    }
}

// 問題報告
function reportIssue() {
    const examInfo = `${examDetailData.title}(${examDetailData.examType}, ${examDetailData.year}年度)`;
    const message = `以下の試験について問題を報告します:\n\n試験: ${examInfo}\nURL: ${window.location.href}\n\n問題の詳細:\n`;
    
    const mailtoLink = `mailto:admin@example.com?subject=試験問題の報告&body=${encodeURIComponent(message)}`;
    window.location.href = mailtoLink;
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
    
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printExamQuestions();
    }
});

// 画像の遅延読み込み対応
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLvlg4/jgYzopovjgaTjgYvjgorjgb7jgZvjgpM8L3RleHQ+PC9zdmc+';
            this.alt = '画像が見つかりません';
        });
    });
});
</script>

<style>
/* 印刷用スタイル */
@media print {
    .btn, .modal, nav, .card-header h5 {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    
    .badge {
        border: 1px solid #000 !important;
        color: #000 !important;
    }
}

/* カードホバー効果 */
.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* 画像ホバー効果 */
img[onclick] {
    transition: transform 0.2s ease-in-out;
}

img[onclick]:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}